# Seasonal Adjustment {.unnumbered}

using a ws structure stand alone with R packages (TS objects or num vectors)

-   approach choice: cf tool selection chapter
-   explanations below work for both soltions
-   how to read a ws in R also in tool selection

In this chapter frequancies lower than monthly and integer periodocities In the HF chpater higher frequencies and non integer periodicities.

## Motivation

The primary aim of the seasonal adjustment process is to remove seasonal fluctuations from the time series. Seasonal fluctuations are quasi-periodic infra-annual movements. They can mask...

\[insert def SA from b_ov\]

-   infra annual peridodic numbers
-   no unamigous definititon
-   depends on its practial estimation

## Data frequencies : high and low

Until recently seasonal where designed to tackly monthly frequencies or lower in JD+, X13- Seats Arima : 2,4,12 Seats : 2,3,4,6,12

For infra monthly data

## Unobserved Components (UC)

The main components, each representing the impact of certain types of phenomena on the time series ($X_{t}$), are:

-   The trend ($T_{t}$) that captures long-term and medium-term behaviour;

-   The seasonal component ($S_{t}$) representing intra-year fluctuations, monthly or quarterly, that are repeated more or less regularly year after year;

-   The irregular component ($I_{t}$) combining all the other more or less erratic fluctuations not covered by the previous components.

In general, the trend consists of 2 sub-components:

-   The long-term evolution of the series;

-   The cycle, that represents the smooth, almost periodic movement around the long-term evolution of the series. It reveals a succession of phases of growth and recession. Trend and cycle are not separated in SA alogrithms.

Two decomposition models:

-   The additive model: $X_{t} = T_{t} + S_{t} + I_{t}$;

-   The multiplicatve model: $X_{t} = T_{t} \times S_{t} \times I_{t}$.

In the Reg-Arima (link) or Tramo(link) modelling the the multplicative model is estimated in logs; $log(X_{t}) = log(T_{t}) + log(S_{t}) + log(I_{t})$; Seats decompostion also relies on logs wheres X-11 decomp operates...

## Detecting seasonal patterns

Seasonality tests (chap M_Tests)

## Available algorithms

(link to table)

The two most popular are..

X-13ARIMA is a seasonal adjustment program developed and supported by the U.S. Census Bureau. It is based on the U.S. Census Bureau's earlier X-11 program, the X-11-ARIMA program developed at Statistics Canada, the X-12-ARIMA program developed by the U.S. Census Bureau.

Tramo-Seats

Those will be the most detailed in this doc, but there alternative solutions.

STL

BSM

X13 and TS are two step algos, pretreatment +dcomp (no pre ptreatment in STL + all at once in BSM)

-   pre-treatment objectives and methods

-   decomposition objective and methods

## Pre-treatment : Reg-ARIMA (or TRAMO)

### why ?
let's call it regArima modelling (and tramo only when TRamo differences are outlined)

### global outline

global structure regression with ARIMA structure for residuals

we'll see it in more details 

- regressors
- calendar (auto and user)
- outliers (auto and user)
- adding intervention variables 
(here: just how to feed the model, details on regressor and calendar specif chapter)
- model

RegArima modelling  part can be of an SA process
or run on its own 
- GUI 
- R
(sligthly different specs,...)

Template for each sub part
- Default params: (quick launch) INPUT (?) 
- Setting User-defined parameters (and not at the end post diagnostics ?)
- Output1: series 
- Output2: Final Params 
- Output3: Diagnostics 


### Calendar correction

Rationale : why correct (in a sentence)

Guidelines ..it has to make sense ex-ante

Method regression as deterministic effects

details of regressor building in calendar chapter


#### Default specifications
cf defalut spec tab 

- working days - trading days - easter - national calmendars not taken into accout

set this option GUI specif detail R

#### Customizing calendars

How to correct this ? solution 1: if working with GUI build a new calendar in GUI (chap C) set this option import it : here

solution 2: import external regressors can be built with rjd3modelling (link)

set this option

Output2: Final Params TEST of presence or 
not GUI

Output3: Diagnostics - results of regression student, F test - td spectral peaks - residual effect in $SA$ or $I$ series

(worked example: french calendar in R)

### Outliers and intervention variables

#### rationale

improve decomposition (cf guidelines)

#### method

regression

#### Outlier types

#### Automatic detction

for BSM cf below modifing specifs - type - critical value - span

(link to revision policies)

#### Pre-specified Outliers

#### User-defined input : building regressors

rjd3modelling

#### Outliers vs intervention variables

assigning to componenets

#### Allocation of effects

##### output

### Reg-Arima Model

Tramo and Reg-Arima are very similar...details in M chapter, parameters and output are the same, treated as one here

Output1: series (if relevant) 
Retrieve regressors GUI (cruncher) R

Retrieve Pre-adjustment series Table

in GUI (cruncher)

in R

Output2: Final Params what is selected and estimated by the software (not in the specifs above)

arima orders (if relevant) and coefficients

GUI

R

Output3: Diagnostics Goodness of fit (principle : first diagnostics then what can be fine tuned)

User defined parameters
ARIMA model parameters


Modifiying specifications 
GUI 

R

### Modelling
(small addendum)
the reg arima part can be run without decompostion slight differences in parameters

## X-11 Decompostion

this part should allow to use x-11 via R as well as via GUI

### Default specifications

| Spec identifier | Log/level detection | Outliers detection | Calendar effects | ARIMA          |
|---------------|---------------|---------------|---------------|---------------|
| RSA0            | *NA*                | *NA*               | *NA*             | Airline(+mean) |
| RSA1            | automatic           | AO/LS/TC           | *NA*             | Airline(+mean) |
| RSA2c           | automatic           | AO/LS/TC           | 2 TD vars+Easter | Airline(+mean) |
| RSA3            | automatic           | AO/LS/TC           | *NA*             | automatic      |
| RSA4c           | automatic           | AO/LS/TC           | 2 TD vars+Easter | automatic      |
| RSA5            | automatic           | AO/LS/TC           | 6 TD vars+Easter | automatic      |
| X-11            | *NA*                | *NA*               | *NA*             | *NA*           |

if identifiers slightly different in GUI, make it clear + pb of names in V3

in calendar effects : what is tested, link to calendar chapter

typos : RJDemetra doc (pull req)

-   7 TD vars

### Quick Launch

(linked from intro JDemetra+ intro chapter )

### Output 1: series

| Series                    | Final X11 name | Final Results | Reallocation of pre-adjustment effects |
|-----------------|-----------------|-----------------|-----------------------|
| Raw series (forecasts)    |                | y (y_f)       |                                        |
| Final seasonal component  | D16            | s (s_f)       |                                        |
| Final trend               | D12            | t (t_f)       |                                        |
| Final irregular           | D13            | i (i_f)       |                                        |
| Calendar component        |                |               |                                        |
| Seasonal without calendar | D10            |               |                                        |

make clear reallocation of outliers effects (frequent questions)

reallocation of intervention variables effects

att : diff D10 and D16 ?

X-11 gives access to a great part of it's intermediate computations (link to M chapter)

Here we focus on the final components main series (= 2nd part of D tables, outliers effects added)

List of series (edit : table with name and meaning)

Retrieve in GUI (forecasts glued)

link to chap GUI : generate output in GUI (generic) link to chap cruncher : generate output with cruncher

Retrieve in R (forecast in a specific variable)

Link to appendix: final output overview

### Output 2: final parameters

Relevant if parameters not set manually, or any parameters automatically selected by the software without having a fixed default value. (The rest of the parameters is set in the spec) To manually set hose parameters and see all the fixed default values see Specifications / parameters section

Final trend filter : length of Henderson filter applied for final estimation (in the second part of the D step).

Final seasonal filer: length of Henderson filter applied for final estimation (in the second part of the D step).

Retrieve via GUI image ? Node Decomposition(X11) \> Final Filters (make node clickable, link to GUI chapter, handling of nodes)

Retrieve in R From the model_sa object (link to R package chap global explanation)

```{r, eval=FALSE}

model_sa$decomposition$s_filter
model_sa$decomposition$t_filter

# add version 3 equivalent
```

### Output 3: diagnostics

X11 produces the following type diagnostics or quality measures Table with link to detail - SI ratios

#### SI-ratios

It is a plot (paste example)

Description, and computation details

Retrieve in GUI NODE Main Results \> SI-Ratios

in GUI values cannot be retrieved Retrieve in R

```{r, eval=FALSE}
# data frame with values 
model_sa$decomposition$si_ratio
# customizable plot
plot(model_sa, type= "cal-seas-irr",first_date = c(2015, 1))

# add version 3 equivalent
```

#### M-statistics

At the end of the decomposition, X-11 algorithm provides quality mesures of the decomposition called "M statistics": 11 statistics (M1 to M11) and 2 summary indicators (Q et Q-M2). By design (clickable) $0<M_x<3$ and acceptance region is $M_x \leq 1$ Formula for $Q$ (They are based on F-tables)

-   **M1** The relative contribution of the irregular over three months span
-   **M2** The relative contribution of the irregular component to the stationary portion of the variance
-   **M3** The amount of month to month change in the irregular component as compared to the amount of month to month change in the trend-cycle (I/C-ratio)
-   **M5** MCD (Months for Cyclical Dominance): The number of months it takes the change in the trend-cycle to surpass the amount of change in the irregular
-   **M6** The amount of year to year change in the irregular as compared to the amount of year to year change in the seasonal (only valid for 3x5 seasonal filter)
-   **M7** The amount of moving seasonality present relative to the amount of stable seasonality
-   **M8** The size of the fluctuations in the seasonal component throughout the whole series
-   **M9** The average linear movement in the seasonal component throughout the whole series
-   **M10** Same as 8, calculated for recent years only (4 years, N-2 to N-5)
-   **M11** Same as 9, calculated for recent years only

For futher details link to Lothian-Mory (quid in M_meth X11)

Retrieve in GUI NODE Decompostion(X-11) \> Quality Measures \> Summary

Retrieve in R

```{r, eval=FALSE}

model_sa$decomposition$mstats
# add version 3 equivalent
```

#### Detailed Quality measures

List (+ link to chap M: add descp from Lothian Mory/ current doc) make clear: on whic x11 series is the measure based

in GUI all the diagnostics below can be retrieved in NODE Decomposition(X-11) \> Quality Measures \> Details

If a stat can be retrievedin R, the code example is in the corresponding paragraph, otherwise it is not possible

##### Average differences without regard to sign over the indicated span

##### Relative contribution to the variance of the differences in the components of the original series

##### Average differences with regard to sign and standard deviation over indicated span

##### Average duration of run

##### I/C ratio over indicated span

##### I/C ratio (global)

##### Relative contribution to the stationnary part of the variance in the original series

##### Autocorrelations in the irregular

##### Heteroskedasticity

Cochran test on equal variances within each period

##### Moving seasonality ratios (MSR)

### User-defined parameters

Here is described how to change default values or automatic choices.

##### General settings

-   **Mode**
    -   check if this option still works, if so add and edit instructions from old page)
    -   if not but button present : explain that the mode is determined in pre-adjustment (function)
-   **Seasonal component**
    -   check if still relevant, idem as above
    -   in v.2.3 if not ticked, S estimated but options on seasonal filter not available
-   **Forecasts horizon**

Length of the forecasts generated by the RegARIMA model - in months (positive values) - years (negative values) - if set to is set to 0, the X-11 procedure does not use any model-based forecasts but the original X-11 type forecasts for one year. - default value: -1, thus one year from the Arima model

-   **Backcasts horizon**

Length of the backcasts generated by the RegARIMA model - in months (positive values) - years (negative values) - default value: 0

##### Irregular correction

-   **LSigma**

    -   sets lower sigma (standard deviation) limit used to down-weight the extreme irregular values in the internal seasonal adjustment iterations, learn more here (LINK to M\_ chapter)
    -   values in $[0,Usigma]$
    -   default value is 1.5

-   **USigma**

    -   sets upper sigma (standard deviation)
    -   values in $[Lsigma,+\infty]$
    -   default value is 2.5

-   **Calendarsigma**

    -   allows to set different **LSigma** and **USigma** for each period
    -   values
        -   None (default)
        -   All: standard errors used for the extreme values detection and adjustment computed separately for each calendar month/quarter
        -   Signif: groups determined by cochran test (check)
        -   Sigmavec: set two customized groups of periods

-   **Excludeforecasts**

    -   ticked : forecasts and backcasts from the RegARIMA model not used in Irregular Correction
    -   unticked (default): forecasts and backcasts used

##### Seasonality extraction filters choice

Specifies which be used to estimate the seasonal factors for the entire series (link to relevant part in M chapter):

-   **Seasonal filter**

-   default value: *MSR* (Moving seasonality ratio), automatic choice of final seasonal filter (cf msr defintion and decison table: link ), initial filters are computed with $3\times 3$

-   choices : $3\times 1$, $3\times 3$, $3\times 5$, $3\times 9$, $3\times 15$ or Stable

-   "Stable" : constat factor for each calendar period (simple moving average of all $S+I$ values for each period)

User choices will be applied to all steps or only to final phase D step.

The seasonal filters can be selected for the entire series, or for a particular month or quarter.

-   **Details on seasonal filters**

Sets different seasonal filters by period in order to account for seasonal heteroskedasticity (link to M chapter)

-   default value: empty

##### Trend estimation filters

-   **Automatic Henderson filter** our user-defined

    -   default: length 13
    -   unticked: user defined length choice

-   **Henderson filter** length choice

    -   values: odd number in $[3,101]$
    -   default value: 13

Check: will user choice be applied to all steps or only to final phase D step

#### Parameter setting in GUI

Specification (general or particular to one series) image

All the parameters above can be set with the specification (link to general explanations) box

#### Parameter setting in R packages

extensive help on functions available in package help pages Rcode snippets

In R, to implement any param change, it is required to retrieve current spec, modify it and apply it again (see T R packages chapter for details). (specific link)

here example changing all the settings (just remove irrelevant changes)

Rjdemetra (v2) Edit : here static R code link to a "worked example" wih dynamic code ticked box in GUI corresponds to ...? in R

```{r eval=FALSE}
#Creating a modified specification, customizing all available X11 parameters
modified_spec<- x13_spec(current_sa_model,
    #x11.mode="?",
    #x11.seasonalComp = "?",
    x11.fcasts = -2,
    x11.bcasts = -1,
    x11.lsigma = 1.2,
    x11.usigma = 2.8,
    x11.calendarSigma = NA, # EDIT with example
      x11.sigmaVector = NA,
    x11.excludeFcasts = NA
    # filters 
    x11.trendAuto = NA, # needed inf value ?
    x11.trendma = 23,
    x11.seasonalma = "S3X9
    # details on seasonal filters ?)

#New SA estimation : apply modified_spec
modified_sa_model<-x13(raw_series,modified_spec)

```

EDIT : link to package help page v2 +v3

## SEATS Decomposition

policy: what is readable in GUI should be explained (even if shortly with link to details here) intermediate series ?

decomp of lineraized series in level or log

### Default specifications

| Spec identifier | Log/level detection | Outliers detection | Calendar effects | ARIMA          |
|---------------|---------------|---------------|---------------|---------------|
| RSA0            | *NA*                | *NA*               | *NA*             | Airline(+mean) |
| RSA1            | automatic           | AO/LS/TC           | *NA*             | Airline(+mean) |
| RSA2            | automatic           | AO/LS/TC           | 2 TD vars+Easter | Airline(+mean) |
| RSA3            | automatic           | AO/LS/TC           | *NA*             | automatic      |
| RSA5            | automatic           | AO/LS/TC           | 6 TD vars+Easter | automatic      |
| RSAfull         | automatic           | AO/LS/TC           | automatic        | automatic      |

if identifiers slightly different in GUI, make it clear + pb of names in V3

in calendar effects : what is tested, link to calendar chapter

typos : RJDemetra doc (pull req)

-   7 TD vars

### Quick Launch

overall procedure

in GUI

in R

### Output 1: series

global indications: \_f: forecasts - \_e - -ef

#### Stochastic series

decompostion of the linearisezed series or of its log if multiplicative model

components: t_lin, s_lin, i_lin

if log, everything is dispalayed in log

| Series Name             | Meaning |
|-------------------------|---------|
| decomposition.y_lin     |         |
| decomposition.y_lin_f   |         |
| decomposition.y_lin_ef  |         |
| decomposition.t_lin     |         |
| decomposition.t_lin_f   |         |
| decomposition.t_lin_e   |         |
| decomposition.t_lin_f   |         |
| decomposition.sa_lin    |         |
| decomposition.sa_lin_f  |         |
| decomposition.sa_lin_e  |         |
| decomposition.sa_lin_ef |         |
| decomposition.s_lin     |         |
| decomposition.s_lin_f   |         |
| decomposition.s_lin_e   |         |
| decomposition.s_lin_ef  |         |
| decomposition.i_lin     |         |
| decomposition.i_lin_f   |         |
| decomposition.i_lin_e   |         |
| decomposition.i_lin_ef  |         |

Retrieve in GUI

NODE : Decompostion \> Stocastic series

forecast f series are pasted at the end of the correspoding series

-   \_e series are labelled with (stde)

\_ef appear in graphs (but values cannot be retrieved)

IMAGE1 GUI

-   image 1 : decompostion node and series

-   image 2 trend graph

-   image 3 seasonal graph

Retrieve in R

#### Components (Level)

if additive model : same as

decompostion of the linearisezed series or of its log if multiplicative model

components: t_lin, s_lin, i_lin

if log, everything is dispalayed in log

| Series Name             | Meaning |
|-------------------------|---------|
| decomposition.y_lin     |         |
| decomposition.y_lin_f   |         |
| decomposition.y_lin_ef  |         |
| decomposition.t_lin     |         |
| decomposition.t_lin_f   |         |
| decomposition.t_lin_e   |         |
| decomposition.t_lin_f   |         |
| decomposition.sa_lin    |         |
| decomposition.sa_lin_f  |         |
| decomposition.sa_lin_e  |         |
| decomposition.sa_lin_ef |         |
| decomposition.s_lin     |         |
| decomposition.s_lin_f   |         |
| decomposition.s_lin_e   |         |
| decomposition.s_lin_ef  |         |
| decomposition.i_lin     |         |
| decomposition.i_lin_f   |         |
| decomposition.i_lin_e   |         |
| decomposition.i_lin_ef  |         |

Retrieve in GUI

NODE : Decompostion \> Stocastic series

forecast f series are pasted at the end of the correspoding series

-   \_e series are labelled with (stde)

\_ef appear in graphs (but values cannot be retrieved)

IMAGE1 GUI

-   image 1 : decompostion node and series

-   image 2 trend graph

-   image 3 seasonal graph

Retrieve in R

Biais correction voir JP (done between lin and and comp ?)

#### Final series

decompostion of the linearisezed series or of its log if multiplicative model

components: t_lin, s_lin, i_lin

if log, everything is dispalayed in log

| Series Name             | Meaning |
|-------------------------|---------|
| decomposition.y_lin     |         |
| decomposition.y_lin_f   |         |
| decomposition.y_lin_ef  |         |
| decomposition.t_lin     |         |
| decomposition.t_lin_f   |         |
| decomposition.t_lin_e   |         |
| decomposition.t_lin_f   |         |
| decomposition.sa_lin    |         |
| decomposition.sa_lin_f  |         |
| decomposition.sa_lin_e  |         |
| decomposition.sa_lin_ef |         |
| decomposition.s_lin     |         |
| decomposition.s_lin_f   |         |
| decomposition.s_lin_e   |         |
| decomposition.s_lin_ef  |         |
| decomposition.i_lin     |         |
| decomposition.i_lin_f   |         |
| decomposition.i_lin_e   |         |
| decomposition.i_lin_ef  |         |

Retrieve in GUI

NODE : Decompostion \> Stocastic series

forecast f series are pasted at the end of the corresponding series

-   \_e series are labelled with (stde)

\_ef appear in graphs (but values cannot be retrieved)

IMAGE1 GUI

-   image 1 : decompostion node and series

-   image 2 trend graph

-   image 3 seasonal graph

Retrieve in R

make clear reallocation of outliers effects (frequent questions)

Table

GUI

R

### Output2: Final Params

what is chosen automatically or default (cf estp) Relevant if parameters not set manually, or any parameters automatically selected by the software without having a fixed default value. (The rest of the parameters is set in the spec) To manually set hose parameters and see all the fixed default values see Specifications / parameters section

here all have a default value, nothing to be automatically selected

### Output3: Diagnostics

SEATS (model based) specific diagnostics
check GUI (more plots, values) vs R
links to methods chapter, here just be able to "read" (knowledge assumed)
(here direct base on gui plots, and the add what can be retrieved in R, if cannot be retrieved in R : could it be rebuild from available elements)
Obj : simple description
res : current doc, jpslides, doc esp, Q JP 

- WK analysis

components 
final estimators

- Error analysis
autocorrelation of the errors (sa, trend)
revisons of the errors 

- Growth rates

- Model based tests

- Significant seasonality 

- Stationnary variance decompostion

### Fine-tuning : user defined parameters

-   Prediction length

Forecast span used in the decomposition
default: one year (-1)
(years are set in negative values, positive values indicate nimber of periods)

-   Approximation Mode

Modification type for inadmissible models
None (default)
Legacy 
Noisy

-   MA unit root boundary

Modulus threshold for resetteing MA "near-unit" roots [0,1] default (0.95)

-   Trend Boundary
Modulus thershold for assingning positive real AR Roots
[0,1] default (0.5)

-   Seasonal Tolerance
Degree threshold for assigning complex AR roots 
[0,10] default (2)

-   Seasonal Boundary (unique)
Modulus threshold for assigning negative real AR roots
[0,1] default (0.8)


-   Seasonal Boundary (unique)
Same modulus threshold unique seasonal AR roots 
[0,1] default (0.8)

-   Method

Algorithm used for estimation of unobserved componements

Burman (default)

KalmanSmoother

McEllroyMatrix

Further explanation (cf slides JP)

link to M chapter for details on root allocation

##### Set in GUI
In specification window (link to GUI global exp)

IMAGE 

##### Set in R
version 2 (RJDemetra)
```{r, eval=FALSE}
tramoseats_spec(
 spec = c("RSAfull", "RSA0", "RSA1", "RSA2", "RSA3", "RSA4", "RSA5"),
  fcst.horizon = NA_integer_,
  seats.predictionLength = NA_integer_,
  seats.approx = c(NA, "None", "Legacy", "Noisy"),
  seats.trendBoundary = NA_integer_,
  seats.seasdBoundary = NA_integer_,
  seats.seasdBoundary1 = NA_integer_,
  seats.seasTol = NA_integer_,
  seats.maBoundary = NA_integer_,
  seats.method = c(NA, "Burman", "KalmanSmoother", "McElroyMatrix")
)

```

in version 3 with {rjd3tramoseats}


## STL

use on linearized data data, no pre-adjustment
(2nd layer)

## SSF
(2nd layer)

## Quality assessment

### Residual seasonality

### Residual calendar effects
